name: Build CHM Viewer

on:
  push:
    branches: [ main ]

jobs:
  build-windows:
    name: Windows 10 Pro 64-Bit
    runs-on: windows-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3
      
    - name: Restore Lazarus/FPC Cache
      uses: actions/cache@v4
      with:
        path: C:\tools\lazarus
        key: lazarus-fpc-${{ runner.os }}-v1
        restore-keys: lazarus-fpc-${{ runner.os }}-
    
    - name: Compile CHM Library Package
      shell: cmd
      run: |
        set %BASEDIR%=%cd%
        set PATH=%PATH%;C:\lazarus;C:\lazarus\fpc\3.2.2\bin\x86_64-win64
        echo %PATH%
        lazbuild "C:\lazarus\components\chmhelp\packages\help\lhelpcontrolpkg.lpk"
        lazbuild "%BASEDIR%\src\CEF4Delphi\packages\cef4delphi_Lazarus.lpk
        dir
        
    - name: Compile chmViewer Project
      shell: cmd
      run: |
        set BASEDIR=%cd%
        dir %BASEDIR%
        C:\tools\Lazarus\lazbuild.exe "%BASEDIR%\src\chmViewer.lpi
    
    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: chmViewer-Windows.exe
        path: chmViewer.exe
        
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
  
    - name: Install FPC + Lazarus
      run: |
        sudo apt update
        sudo apt install -y fpc lazarus lcl-utils lcl-gtk2
        
    - name: Compile Laz
      run: |
        which lazbuild
        which fpc
        
    - name: Compile Lazarus project (.lpi)
      shell: bash
      run: |
        export BASEDIR=$(pwd)
        echo "base: $BASEDIR"
        /usr/bin/lazbuild $BASEDIR/src/chmViewer.lpi

    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: chmViewer-linux
        path: chmViewer
